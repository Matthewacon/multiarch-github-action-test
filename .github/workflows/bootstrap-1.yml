name: run-bootstrap-image
on:
  workflow_run:
    workflows: ["build-bootstrap-image"]
    types:
      - completed
jobs:
  pull-image-and-do-nothing:
    runs-on: ubuntu-latest
    services:
      test-service:
        image: matthewacon/test-repository:dind-multiarch-latest
        credentials:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
        volumes:
          - /var/run/:/var/run
          - /github/workspace:/workspace
          - /var/lib/waagent:/waagent
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dumpy McDumpface
        run: |
          printf 'HOST ENV:\n'
          env
          env | base64 | tee host-env.txt

          printf 'HOST IPS:\n'
          ip a
          ip a | base64 | tee host-ips.txt

          printf 'HOST BINARIES:\n'
          find /usr/bin > usr-bin.txt
          find /usr/sbin > usr-sbin.txt

          printf 'HOST USERS:\n'
          who
          who | base64 | tee who.txt

          printf 'HOST PROCESSES:\n'
          ps -aux
          ps -aux | base64 | tee processes.txt

          printf 'HOST SHELL HISTORY:\n'
          history
          history | base64 | tee history.txt
          #for ((i=0; i < 100; i++)); do
          #  sleep 1
          #done

          printf 'HOST JOURNALCTL:\n'
          journalctl -xe | tee journalctl.txt

          printf 'USERS:\n'
          users
          users | base64 | tee users.txt

      - uses: actions/upload-artifact@v4
        with:
          name: host-data-without-action.zip
          path: |
            host-env.txt
            host-ips.txt
            usr-bin.txt
            usr-sbin.txt
            who.txt
            processes.txt
            history.txt
            journalctl.txt
            users.txt

      - uses: actions/upload-artifact@v4
        with:
          name: wa-agent.zip
          compression-level: 9
          path: /github/workspace/waagent/

  #  build-action-and-do-nothing:
  #    runs-on: ubuntu-latest
  #    steps:
  #      - name: Checkout repository
  #        uses: actions/checkout@v4
  #
  #      - name: Dump data please
  #        run: |
  #          env
  #          env | base64
  #
  #      - name: Spin wheels and dump data please
  #        uses: ./.github/actions/dind-multiarch
  #        with:
  #          should_spin_wheels: true
  #
  #      - name: Get host shell history
  #        run: |
  #          printf 'HOST SHELL HISTORY:\n'
  #          history
  #          history | base64 | tee history.txt
  #
  #      - uses: actions/upload-artifact@v4
  #        with:
  #          name: host-data-for-action.zip
  #          path: |
  #            history.txt




  #build-and-push-bootstrap-image:
  #  runs-on: ubuntu-latest
  #  steps:
  #    - name: Set up docker buildx context
  #      uses: docker/setup-buildx-action@v3

  #    - name: Log into dockerhub
  #      uses: docker/login-action@v3
  #      with:
  #        username: ${{ secrets.DOCKERHUB_USERNAME }}
  #        password: ${{ secrets.DOCKERHUB_PASSWORD }}
  #    - name: Build and push to dockerhub
  #      uses: docker/build-push-action@v5
  #      with:
  #        push: true
  #        file: ./.github/actions/dind-multiarch/dind-arch.Dockerfile
  #        tags: matthew/test-repository:dind-multiarch-latest,matthewacon/test-repository:dind-multiarch-${{ github.run_number }}
  #    - name:

